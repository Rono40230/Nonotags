

<!DOCTYPE html>
<html class="writer-html5" lang="fr" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ui.views.main_window &mdash; Documentation Nonotags 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=05dadb3a"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/translations.js?v=e6b791cb"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Nonotags
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Guide utilisateur:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation de Nonotags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utilisation.html">Guide d’utilisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_core.html">API Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_services.html">API Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_ui.html">API UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_support.html">API Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_database.html">API Database</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules détaillés:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">core</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Nonotags</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Code du module</a></li>
      <li class="breadcrumb-item active">ui.views.main_window</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Code source de ui.views.main_window</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Application principale Nonotags</span>
<span class="sd">Gestionnaire de l&#39;application avec fenêtre principale et navigation</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gi</span>
<span class="n">gi</span><span class="o">.</span><span class="n">require_version</span><span class="p">(</span><span class="s1">&#39;Gtk&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">gi.repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gtk</span><span class="p">,</span> <span class="n">GLib</span><span class="p">,</span> <span class="n">Gdk</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ui.startup_window</span><span class="w"> </span><span class="kn">import</span> <span class="n">StartupWindow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ui.components.album_card</span><span class="w"> </span><span class="kn">import</span> <span class="n">AlbumCard</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ui.processing_orchestrator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessingOrchestrator</span><span class="p">,</span> <span class="n">ProcessingState</span><span class="p">,</span> <span class="n">ProcessingStep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ui.views.exceptions_window</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExceptionsWindow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.refresh_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">refresh_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ui.transitions.header_migration</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeaderMigration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">support.config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ui.managers.persistent_window_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">persistent_window_manager</span><span class="p">,</span> <span class="n">WindowType</span>

<div class="viewcode-block" id="NonotagsApp">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NonotagsApp</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application Nonotags avec séquence de démarrage&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup_window</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resize_timeout_id</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Configuration et migration HeaderBar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_migration</span> <span class="o">=</span> <span class="n">HeaderMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># Orchestrateur de traitement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span> <span class="o">=</span> <span class="n">ProcessingOrchestrator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_orchestrator_callbacks</span><span class="p">()</span>
        
        <span class="c1"># Initialiser les factories pour les fenêtres persistantes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_persistent_window_factories</span><span class="p">()</span>
        
        <span class="c1"># Interface de progression (pour affichage pendant traitement automatique)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_label</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Configuration lazy loading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_batch</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Nombre d&#39;albums à charger par lot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_albums_data</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Tous les albums scannés</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayed_album_cards</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Cards actuellement affichées</span>
    
<div class="viewcode-block" id="NonotagsApp.run">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lance l&#39;application avec la fenêtre de démarrage&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup_window</span> <span class="o">=</span> <span class="n">StartupWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startup_window</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
        
        <span class="n">Gtk</span><span class="o">.</span><span class="n">main</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="NonotagsApp.create_main_window_with_scan">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.create_main_window_with_scan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_main_window_with_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crée la fenêtre principale et lance le scan du dossier&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_main_window</span><span class="p">()</span>
        
        <span class="c1"># Lancer le scan automatiquement</span>
        <span class="c1"># Simuler le scan pour l&#39;instant</span>
        <span class="n">GLib</span><span class="o">.</span><span class="n">idle_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_folder</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_scan_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scanne un dossier et ajoute les albums trouvés&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Stocker le dossier actuel pour rescans futurs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span> <span class="o">=</span> <span class="n">folder_path</span>
            
            <span class="kn">from</span><span class="w"> </span><span class="nn">services.music_scanner</span><span class="w"> </span><span class="kn">import</span> <span class="n">MusicScanner</span>
            <span class="n">scanner</span> <span class="o">=</span> <span class="n">MusicScanner</span><span class="p">()</span>

            <span class="n">albums</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">scan_directory</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            
            <span class="c1"># ✅ TRI PAR ANNÉE CROISSANTE : Trier les albums avant affichage</span>
            <span class="n">albums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_albums_by_year</span><span class="p">(</span><span class="n">albums</span><span class="p">)</span>

            <span class="c1"># MODIFICATION: Stocker tous les albums pour lazy loading</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_albums_data</span> <span class="o">=</span> <span class="n">albums</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayed_album_cards</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># MODIFICATION: Ne plus effacer les albums existants</span>
            <span class="c1"># Initialiser les listes si elles n&#39;existent pas</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;loaded_albums&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Vérifier si on a des albums existants dans la grille</span>
            <span class="n">existing_albums_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">get_children</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="c1"># Si c&#39;est le premier import ET que la grille contient des albums de démo</span>
            <span class="c1"># (détecté par le fait qu&#39;il n&#39;y a pas encore de loaded_albums réels)</span>
            <span class="k">if</span> <span class="n">existing_albums_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Effacer seulement les albums de démonstration</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                <span class="c1"># Nettoyer aussi la queue de l&#39;orchestrator pour le premier import</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">clear_queue</span><span class="p">()</span>

            <span class="c1"># MODIFICATION: Afficher le premier lot d&#39;albums avec lazy loading</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_next_batch</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
            <span class="c1"># Plus besoin de update_cards_per_line() - FlowBox s&#39;adapte automatiquement</span>

            <span class="c1"># ✅ TRAITEMENT AUTOMATIQUE : Démarrer immédiatement le traitement</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">start_processing</span><span class="p">():</span>
                <span class="k">pass</span>  <span class="c1"># Traitement automatique démarré</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Impossible de démarrer le traitement automatique</span>
            
            <span class="c1"># Sauvegarder le dossier actuel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span> <span class="o">=</span> <span class="n">folder_path</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors du scan: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># En cas d&#39;erreur, garder les albums de démo</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_display_next_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche le prochain lot d&#39;albums avec lazy loading&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_albums_data</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c1"># Tous les albums sont déjà affichés</span>

        <span class="c1"># Calculer le nombre d&#39;albums à afficher dans ce lot</span>
        <span class="n">remaining_albums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_albums_data</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_batch</span><span class="p">,</span> <span class="n">remaining_albums</span><span class="p">)</span>
        
        <span class="c1"># Obtenir le lot d&#39;albums à afficher</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span>
        <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">batch_size</span>
        <span class="n">batch_albums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_albums_data</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">]</span>

        <span class="c1"># Ajouter les albums du lot à l&#39;interface</span>
        <span class="n">new_albums_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="n">batch_albums</span><span class="p">:</span>
            <span class="c1"># Vérifier si l&#39;album n&#39;est pas déjà dans la liste (éviter les doublons)</span>
            <span class="n">album_path</span> <span class="o">=</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">already_exists</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">album_path</span> <span class="ow">or</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">album_path</span> 
                <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">already_exists</span><span class="p">:</span>
                <span class="n">card</span> <span class="o">=</span> <span class="n">AlbumCard</span><span class="p">(</span><span class="n">album</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">album</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayed_album_cards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                <span class="n">new_albums_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">album</span><span class="p">)</span>

        <span class="c1"># Mettre à jour le compteur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="c1"># Ajouter SEULEMENT les nouveaux albums à l&#39;orchestrator</span>
        <span class="k">if</span> <span class="n">new_albums_added</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">add_albums</span><span class="p">(</span><span class="n">new_albums_added</span><span class="p">)</span>

        <span class="c1"># Rafraîchir l&#39;affichage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>

        <span class="c1"># ✅ TRAITEMENT AUTOMATIQUE : Démarrer immédiatement le traitement si c&#39;est le premier lot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span> <span class="o">==</span> <span class="n">batch_size</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">start_processing</span><span class="p">():</span>
            <span class="k">pass</span>  <span class="c1"># Traitement automatique démarré</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_scroll_value_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adjustment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Détecte quand l&#39;utilisateur atteint le bas du scroll pour charger plus d&#39;albums&quot;&quot;&quot;</span>
        <span class="c1"># Vérifier si on est proche du bas (dans les 100 pixels)</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">adjustment</span><span class="o">.</span><span class="n">get_upper</span><span class="p">()</span> <span class="o">-</span> <span class="n">adjustment</span><span class="o">.</span><span class="n">get_page_size</span><span class="p">()</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="n">adjustment</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">max_value</span> <span class="o">-</span> <span class="n">current_value</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Seuil de 100 pixels du bas</span>
            <span class="c1"># Charger le prochain lot si tous les albums ne sont pas encore affichés</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_displayed_count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_albums_data</span><span class="p">):</span>
                <span class="n">GLib</span><span class="o">.</span><span class="n">idle_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_next_batch</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sort_albums_by_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">albums</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trie les albums par ordre croissant des années&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_year_for_sorting</span><span class="p">(</span><span class="n">album</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Extrait l&#39;année pour le tri, avec gestion des cas spéciaux&quot;&quot;&quot;</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">year</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">9999</span>  <span class="c1"># Albums sans année en fin</span>
                
            <span class="n">year_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            
            <span class="c1"># Gestion des compilations avec plusieurs années (ex: &quot;1990, 1993, 1995&quot;)</span>
            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">year_str</span><span class="p">:</span>
                <span class="c1"># Prendre la première année pour le tri</span>
                <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="k">return</span> <span class="mi">9999</span>
            
            <span class="c1"># Extraire les 4 premiers caractères pour l&#39;année (gestion des dates complètes)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">year_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year_str</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
                <span class="c1"># Vérifier que c&#39;est une année valide</span>
                <span class="k">if</span> <span class="mi">1900</span> <span class="o">&lt;=</span> <span class="n">year_int</span> <span class="o">&lt;=</span> <span class="mi">2100</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">year_int</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">9999</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">9999</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sorted_albums</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">albums</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_year_for_sorting</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sorted_albums</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">albums</span>  <span class="c1"># Retourner la liste originale en cas d&#39;erreur</span>
        
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Pour GLib.idle_add</span>
    
<div class="viewcode-block" id="NonotagsApp.remove_album_from_list">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.remove_album_from_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_album_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">album_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Supprime un album de toutes les structures de données</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            album_data: Les données de l&#39;album à supprimer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Supprimer de loaded_albums</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;loaded_albums&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span><span class="p">:</span>
                <span class="n">album_path</span> <span class="o">=</span> <span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">album</span> <span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">album_path</span>
                <span class="p">]</span>
            
            <span class="c1"># Supprimer de la queue de l&#39;orchestrator</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;orchestrator&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="p">:</span>
                <span class="n">album_path</span> <span class="o">=</span> <span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">albums_queue</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">album</span> <span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">albums_queue</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">album_path</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">total_albums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">albums_queue</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors de la suppression de l&#39;album: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="NonotagsApp.create_main_window">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.create_main_window">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_main_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crée la fenêtre principale après le démarrage&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">Window</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">get_style_context</span><span class="p">()</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span><span class="s2">&quot;main-window&quot;</span><span class="p">)</span>  <span class="c1"># Appliquer le style fond blanc</span>
        
        <span class="c1"># Charger le CSS pour les styles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_css</span><span class="p">()</span>
        
        <span class="c1"># Utiliser le système de migration pour configurer l&#39;interface</span>
        <span class="n">use_headerbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_manager</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">use_headerbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_migration</span><span class="o">.</span><span class="n">setup_window_with_mode</span><span class="p">(</span><span class="n">use_headerbar</span><span class="p">)</span>
        
        <span class="c1"># Force l&#39;affichage en plein écran</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">maximize</span><span class="p">()</span>  <span class="c1"># Maximise la fenêtre (recommandé)</span>
        <span class="c1"># Alternative : self.main_window.fullscreen()  # Plein écran sans barre de titre</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">Gtk</span><span class="o">.</span><span class="n">WindowPosition</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;delete-event&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_main_window_close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;size-allocate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_window_resize</span><span class="p">)</span>
        
        <span class="c1"># Container principal avec scroll</span>
        <span class="n">scrolled</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">()</span>
        <span class="n">scrolled</span><span class="o">.</span><span class="n">set_policy</span><span class="p">(</span><span class="n">Gtk</span><span class="o">.</span><span class="n">PolicyType</span><span class="o">.</span><span class="n">AUTOMATIC</span><span class="p">,</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">PolicyType</span><span class="o">.</span><span class="n">AUTOMATIC</span><span class="p">)</span>
        
        <span class="c1"># Connecter le signal de scroll pour lazy loading</span>
        <span class="n">scrolled</span><span class="o">.</span><span class="n">get_vadjustment</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;value-changed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_scroll_value_changed</span><span class="p">)</span>
        
        <span class="n">main_box</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">main_box</span><span class="o">.</span><span class="n">set_margin_left</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">main_box</span><span class="o">.</span><span class="n">set_margin_right</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">main_box</span><span class="o">.</span><span class="n">set_margin_top</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">main_box</span><span class="o">.</span><span class="n">set_margin_bottom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="c1"># Grille d&#39;albums avec affichage responsive et adaptatif</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">FlowBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">set_valign</span><span class="p">(</span><span class="n">Gtk</span><span class="o">.</span><span class="n">Align</span><span class="o">.</span><span class="n">START</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">set_selection_mode</span><span class="p">(</span><span class="n">Gtk</span><span class="o">.</span><span class="n">SelectionMode</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
        
        <span class="c1"># Configuration FlowBox pour affichage responsive sans troncature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">set_homogeneous</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">set_column_spacing</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">set_row_spacing</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">set_min_children_per_line</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">set_max_children_per_line</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Pas de limite artificielle</span>
        
        <span class="n">main_box</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">scrolled</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">main_box</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">scrolled</span><span class="p">)</span>
        
        <span class="c1"># Affichage de la fenêtre principale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
        
        <span class="c1"># Plus besoin de calcul initial - FlowBox s&#39;adapte automatiquement</span>
        
        <span class="c1"># Enregistrer auprès du RefreshManager pour les notifications de rafraîchissement</span>
        <span class="n">refresh_manager</span><span class="o">.</span><span class="n">register_display_component</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># Fermer la fenêtre de démarrage</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startup_window</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startup_window</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startup_window</span> <span class="o">=</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_main_window_close">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_main_window_close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_main_window_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gestionnaire de fermeture de la fenêtre principale&quot;&quot;&quot;</span>
        <span class="c1"># Désenregistrer du RefreshManager</span>
        <span class="n">refresh_manager</span><span class="o">.</span><span class="n">unregister_display_component</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="n">Gtk</span><span class="o">.</span><span class="n">main_quit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_import_clicked">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_import_clicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_import_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import de fichiers/albums individuels&quot;&quot;&quot;</span>

        <span class="n">dialog</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">FileChooserDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Importer des fichiers musicaux ou des albums&quot;</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">FileChooserAction</span><span class="o">.</span><span class="n">SELECT_FOLDER</span>
        <span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">add_buttons</span><span class="p">(</span>
            <span class="s2">&quot;Annuler&quot;</span><span class="p">,</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">ResponseType</span><span class="o">.</span><span class="n">CANCEL</span><span class="p">,</span>
            <span class="s2">&quot;Importer&quot;</span><span class="p">,</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">ResponseType</span><span class="o">.</span><span class="n">OK</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">ResponseType</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>

            <span class="n">dialog</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="c1"># Utiliser la même fonction que pour le scan depuis la fenêtre de démarrage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scan_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">dialog</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_albums_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">albums</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Met à jour l&#39;affichage des albums en conservant les cards existantes&quot;&quot;&quot;</span>
        
        <span class="c1"># ✅ TRI PAR ANNÉE CROISSANTE : Maintenir le tri lors des mises à jour</span>
        <span class="n">albums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_albums_by_year</span><span class="p">(</span><span class="n">albums</span><span class="p">)</span>
        
        <span class="c1"># Au lieu de vider et recréer, mettre à jour les cards existantes</span>
        <span class="n">existing_cards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
        
        <span class="c1"># Créer un dictionnaire des albums par chemin pour mise à jour</span>
        <span class="n">albums_by_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="n">albums</span><span class="p">:</span>
            <span class="n">album_path</span> <span class="o">=</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">album_path</span><span class="p">:</span>
                <span class="n">albums_by_path</span><span class="p">[</span><span class="n">album_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">album</span>
        
        <span class="c1"># Mettre à jour les cards existantes avec les nouvelles métadonnées</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">existing_cards</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s1">&#39;album_data&#39;</span><span class="p">):</span>
                <span class="n">card_path</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">card</span><span class="o">.</span><span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">card_path</span> <span class="ow">in</span> <span class="n">albums_by_path</span><span class="p">:</span>
                    <span class="c1"># Mettre à jour les données de la card</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">album_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">albums_by_path</span><span class="p">[</span><span class="n">card_path</span><span class="p">])</span>
                    <span class="c1"># Mettre à jour l&#39;affichage de la card</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">_update_display</span><span class="p">()</span>
        
        <span class="c1"># Sauvegarder la liste mise à jour (remplacer, pas ajouter)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_albums</span> <span class="o">=</span> <span class="n">albums</span>
        
        <span class="c1"># Pas besoin de recréer les cards ou d&#39;ajouter à l&#39;orchestrator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
    
<div class="viewcode-block" id="NonotagsApp.on_edit_selection_clicked">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_edit_selection_clicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_edit_selection_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ouvre l&#39;édition groupée pour les albums sélectionnés&quot;&quot;&quot;</span>
        <span class="n">selected_albums</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Parcourir les albums et collecter ceux qui sont sélectionnés</span>
        <span class="k">for</span> <span class="n">flowbox_child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
            <span class="n">album_card</span> <span class="o">=</span> <span class="n">flowbox_child</span><span class="o">.</span><span class="n">get_child</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">album_card</span><span class="p">,</span> <span class="s1">&#39;selection_checkbox&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">album_card</span><span class="o">.</span><span class="n">selection_checkbox</span><span class="o">.</span><span class="n">get_active</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">album_card</span><span class="p">,</span> <span class="s1">&#39;album_data&#39;</span><span class="p">):</span>
                    <span class="n">selected_albums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">album_card</span><span class="o">.</span><span class="n">album_data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_albums</span><span class="p">:</span>
            <span class="n">dialog</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
                <span class="n">modal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
                <span class="n">buttons</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">ButtonsType</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Aucun album sélectionné&quot;</span>
            <span class="p">)</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">format_secondary_text</span><span class="p">(</span>
                <span class="s2">&quot;Veuillez sélectionner au moins un album avant d&#39;utiliser l&#39;édition groupée.&quot;</span>
            <span class="p">)</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="k">return</span>
        
        <span class="c1"># Edition groupée demandée - Utiliser le gestionnaire persistant</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎯 Ouverture de la fenêtre d&#39;édition pour </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_albums</span><span class="p">)</span><span class="si">}</span><span class="s2"> albums sélectionnés&quot;</span><span class="p">)</span>
            
            <span class="c1"># Créer identifiant unique pour cette sélection</span>
            <span class="n">album_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">selected_albums</span><span class="p">]</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;edit_group_</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">album_paths</span><span class="p">)))</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="c1"># Créer fenêtre persistante (nouvelle à chaque fois pour édition groupée)</span>
            <span class="n">edit_window</span> <span class="o">=</span> <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">create_or_focus_window</span><span class="p">(</span>
                <span class="n">window_type</span><span class="o">=</span><span class="n">WindowType</span><span class="o">.</span><span class="n">ALBUM_EDIT</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">focus_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Toujours nouvelle fenêtre pour édition groupée</span>
                <span class="n">album_data</span><span class="o">=</span><span class="n">selected_albums</span><span class="p">,</span>
                <span class="n">parent_card</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">edit_window</span><span class="p">:</span>
                <span class="n">edit_window</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors de l&#39;ouverture de la fenêtre d&#39;édition: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">dialog</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
                <span class="n">modal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="n">buttons</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">ButtonsType</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Erreur d&#39;ouverture&quot;</span>
            <span class="p">)</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">format_secondary_text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Impossible d&#39;ouvrir la fenêtre d&#39;édition:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_exceptions_clicked">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_exceptions_clicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_exceptions_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ouvre la fenêtre de gestion des exceptions de casse&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Utiliser le gestionnaire persistant - une seule instance</span>
            <span class="n">exceptions_window</span> <span class="o">=</span> <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">create_or_focus_window</span><span class="p">(</span>
                <span class="n">window_type</span><span class="o">=</span><span class="n">WindowType</span><span class="o">.</span><span class="n">CASE_EXCEPTIONS</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;case_exceptions_main&quot;</span><span class="p">,</span>
                <span class="n">focus_existing</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Focus sur existante si déjà ouverte</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">exceptions_window</span><span class="p">:</span>
                <span class="n">exceptions_window</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors de l&#39;ouverture de la fenêtre des exceptions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_playlists_clicked">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_playlists_clicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_playlists_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ouvre le gestionnaire de playlists&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Utiliser le gestionnaire persistant - une seule instance</span>
            <span class="n">playlist_window</span> <span class="o">=</span> <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">create_or_focus_window</span><span class="p">(</span>
                <span class="n">window_type</span><span class="o">=</span><span class="n">WindowType</span><span class="o">.</span><span class="n">PLAYLIST_MANAGER</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;playlist_manager_main&quot;</span><span class="p">,</span>
                <span class="n">focus_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Focus sur existante si déjà ouverte</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">playlist_window</span><span class="p">:</span>
                <span class="n">playlist_window</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors de l&#39;ouverture du gestionnaire de playlists: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_converter_clicked">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_converter_clicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_converter_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ouvre le convertisseur audio&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Utiliser le gestionnaire persistant - une seule instance</span>
            <span class="n">converter_window</span> <span class="o">=</span> <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">create_or_focus_window</span><span class="p">(</span>
                <span class="n">window_type</span><span class="o">=</span><span class="n">WindowType</span><span class="o">.</span><span class="n">AUDIO_CONVERTER</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;audio_converter_main&quot;</span><span class="p">,</span> 
                <span class="n">focus_existing</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Focus sur existante si déjà ouverte</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">converter_window</span><span class="p">:</span>
                <span class="n">converter_window</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors de l&#39;ouverture du convertisseur audio: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_window_resize">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_window_resize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_window_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">allocation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gestionnaire de redimensionnement de fenêtre avec debouncing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_timeout_id</span><span class="p">:</span>
            <span class="n">GLib</span><span class="o">.</span><span class="n">source_remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resize_timeout_id</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_resize_timeout_id</span> <span class="o">=</span> <span class="n">GLib</span><span class="o">.</span><span class="n">timeout_add</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_resize_update</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_delayed_resize_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Met à jour le layout avec un délai pour éviter les calculs excessifs&quot;&quot;&quot;</span>
        <span class="c1"># Plus besoin de calcul manuel - FlowBox s&#39;adapte automatiquement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resize_timeout_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_orchestrator_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure les callbacks de l&#39;orchestrateur&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">on_state_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_processing_state_changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">on_progress_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_processing_progress_updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">on_step_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_processing_step_changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">on_album_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_album_processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">on_error_occurred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_processing_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">on_processing_completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_processing_completed</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_persistent_window_factories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure les factories pour les fenêtres persistantes&quot;&quot;&quot;</span>
        <span class="c1"># Factory pour fenêtre d&#39;édition d&#39;albums</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">album_edit_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">ui.views.album_edit_window</span><span class="w"> </span><span class="kn">import</span> <span class="n">AlbumEditWindow</span>
            <span class="n">album_data</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;album_data&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">parent_card</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_card&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AlbumEditWindow</span><span class="p">(</span><span class="n">album_data</span><span class="p">,</span> <span class="n">parent_card</span><span class="p">)</span>
        
        <span class="c1"># Factory pour gestionnaire de playlists  </span>
        <span class="k">def</span><span class="w"> </span><span class="nf">playlist_manager_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">ui.views.playlist_manager_window</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlaylistManagerWindow</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">PlaylistManagerWindow</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
            
        <span class="c1"># Factory pour fenêtre des exceptions de casse</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">case_exceptions_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">ui.views.exceptions_window</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExceptionsWindow</span>
            <span class="k">return</span> <span class="n">ExceptionsWindow</span><span class="p">()</span>
            
        <span class="c1"># Factory pour convertisseur audio</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">audio_converter_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">ui.views.audio_converter_window</span><span class="w"> </span><span class="kn">import</span> <span class="n">AudioConverterWindow</span>
            <span class="k">return</span> <span class="n">AudioConverterWindow</span><span class="p">()</span>
        
        <span class="c1"># Enregistrer les factories</span>
        <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">register_window_factory</span><span class="p">(</span><span class="n">WindowType</span><span class="o">.</span><span class="n">ALBUM_EDIT</span><span class="p">,</span> <span class="n">album_edit_factory</span><span class="p">)</span>
        <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">register_window_factory</span><span class="p">(</span><span class="n">WindowType</span><span class="o">.</span><span class="n">PLAYLIST_MANAGER</span><span class="p">,</span> <span class="n">playlist_manager_factory</span><span class="p">)</span>
        <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">register_window_factory</span><span class="p">(</span><span class="n">WindowType</span><span class="o">.</span><span class="n">CASE_EXCEPTIONS</span><span class="p">,</span> <span class="n">case_exceptions_factory</span><span class="p">)</span>
        <span class="n">persistent_window_manager</span><span class="o">.</span><span class="n">register_window_factory</span><span class="p">(</span><span class="n">WindowType</span><span class="o">.</span><span class="n">AUDIO_CONVERTER</span><span class="p">,</span> <span class="n">audio_converter_factory</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Factories des fenêtres persistantes configurées&quot;</span><span class="p">)</span>
    
    <span class="c1"># === CALLBACKS DE L&#39;ORCHESTRATEUR ===</span>
    
<div class="viewcode-block" id="NonotagsApp.on_processing_state_changed">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_processing_state_changed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_processing_state_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback changement d&#39;état du traitement&quot;&quot;&quot;</span>
        <span class="n">state_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ProcessingState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span> <span class="s2">&quot;Inactif&quot;</span><span class="p">,</span>
            <span class="n">ProcessingState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span> <span class="s2">&quot;En cours&quot;</span><span class="p">,</span>
            <span class="n">ProcessingState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">:</span> <span class="s2">&quot;En pause&quot;</span><span class="p">,</span> 
            <span class="n">ProcessingState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">:</span> <span class="s2">&quot;Terminé&quot;</span><span class="p">,</span>
            <span class="n">ProcessingState</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="s2">&quot;Erreur&quot;</span><span class="p">,</span>
            <span class="n">ProcessingState</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">:</span> <span class="s2">&quot;Annulé&quot;</span>
        <span class="p">}</span>
        
        <span class="n">state_name</span> <span class="o">=</span> <span class="n">state_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_state</span><span class="p">,</span> <span class="s2">&quot;Inconnu&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">set_markup</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;span size=&#39;small&#39;&gt;État: &lt;b&gt;</span><span class="si">{</span><span class="n">state_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;/span&gt;&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_processing_progress_updated">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_processing_progress_updated">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_processing_progress_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">processed</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback mise à jour du progrès&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">set_fraction</span><span class="p">(</span><span class="n">progress</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> albums (</span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_processing_step_changed">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_processing_step_changed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_processing_step_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">album_number</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback changement d&#39;étape&quot;&quot;&quot;</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">get_step_description</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_label</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_label</span><span class="o">.</span><span class="n">set_markup</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;span size=&#39;small&#39;&gt;Étape: &lt;b&gt;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">&lt;/b&gt; (Album </span><span class="si">{</span><span class="n">album_number</span><span class="si">}</span><span class="s2">)&lt;/span&gt;&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_album_processed">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_album_processed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_album_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">success</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback album traité&quot;&quot;&quot;</span>
        <span class="n">album_title</span> <span class="o">=</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;album&#39;</span><span class="p">,</span> <span class="s1">&#39;Sans titre&#39;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;✅ Réussi&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="s2">&quot;❌ Échec&quot;</span>
        <span class="c1"># Log supprimé car il indiquait de fausses informations d&#39;échec</span>
        
        <span class="c1"># Mettre à jour la carte d&#39;album correspondante</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_album_card_after_processing</span><span class="p">(</span><span class="n">album</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_album_card_after_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">success</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Met à jour la carte d&#39;album après traitement&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">original_folder_path</span> <span class="o">=</span> <span class="n">album</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">original_folder_path</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="c1"># Trouver la carte correspondante dans la grille</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">albums_grid</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="s1">&#39;get_child&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">get_child</span><span class="p">():</span>  <span class="c1"># FlowBoxChild</span>
                    <span class="n">card</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_child</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s1">&#39;album_data&#39;</span><span class="p">):</span>
                        <span class="n">card_folder_path</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;folder_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">card_folder_path</span> <span class="o">==</span> <span class="n">original_folder_path</span><span class="p">:</span>
                            <span class="c1"># ✅ FIX: Mettre à jour directement avec les nouvelles données de l&#39;album</span>
                            <span class="c1"># L&#39;orchestrateur a déjà mis à jour album[&#39;folder_path&#39;]</span>
                            <span class="n">card</span><span class="o">.</span><span class="n">album_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">album</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s1">&#39;_update_display&#39;</span><span class="p">):</span>
                                <span class="n">card</span><span class="o">.</span><span class="n">_update_display</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Carte mise à jour avec les nouvelles données&quot;</span><span class="p">)</span>
                            
                            <span class="k">break</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur mise à jour carte: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_same_music_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vérifie si deux dossiers contiennent les mêmes fichiers musicaux&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
                
            <span class="c1"># Lister les fichiers MP3 dans les deux dossiers</span>
            <span class="n">old_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mp3&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">new_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mp3&#39;</span><span class="p">)]</span>
            
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_files</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    
<div class="viewcode-block" id="NonotagsApp.on_processing_error">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_processing_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_processing_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback erreur de traitement&quot;&quot;&quot;</span>
        
        <span class="c1"># Afficher un dialog d&#39;erreur</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span>
            <span class="n">transient_for</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">buttons</span><span class="o">=</span><span class="n">Gtk</span><span class="o">.</span><span class="n">ButtonsType</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Erreur de traitement&quot;</span>
        <span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">format_secondary_text</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="NonotagsApp.on_processing_completed">
<a class="viewcode-back" href="../../../api_ui.html#ui.views.main_window.NonotagsApp.on_processing_completed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_processing_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">processed</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback traitement terminé&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🎉 Traitement automatique terminé avec succès!</span><span class="se">\n</span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> albums traités et optimisés.&quot;</span>
            
            <span class="c1"># RESCAN pour rafraîchir les cards avec les nouveaux noms</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;current_folder&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span><span class="p">:</span>
                <span class="c1"># SOLUTION: Chercher le nouveau nom du dossier après renommage</span>
                <span class="n">old_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span>
                
                <span class="c1"># Si l&#39;ancien dossier n&#39;existe plus, chercher le nouveau nom</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_folder</span><span class="p">):</span>
                    <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">old_folder</span><span class="p">)</span>
                    
                    <span class="c1"># Chercher un dossier qui commence par une parenthèse (format RÈGLE 17)</span>
                    <span class="n">new_folder</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">):</span>
                            <span class="n">item_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">):</span>
                                <span class="c1"># Vérifier si ce dossier contient des MP3</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">mp3_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mp3&#39;</span><span class="p">)]</span>
                                    <span class="k">if</span> <span class="n">mp3_files</span><span class="p">:</span>
                                        <span class="n">new_folder</span> <span class="o">=</span> <span class="n">item_path</span>
                                        <span class="k">break</span>
                                <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                                    <span class="k">continue</span>
                    
                    <span class="k">if</span> <span class="n">new_folder</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span> <span class="o">=</span> <span class="n">new_folder</span>
                
                <span class="c1"># Au lieu de rescanner avec _scan_folder (qui ajoute des doublons),</span>
                <span class="c1"># utiliser _refresh_albums_display pour mettre à jour les cards existantes</span>
                <span class="n">GLib</span><span class="o">.</span><span class="n">idle_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_refresh_albums_display</span><span class="p">)</span>
            
            <span class="c1"># Dialog de succès - DÉSACTIVÉ sur demande utilisateur</span>
            <span class="c1"># dialog = Gtk.MessageDialog(</span>
            <span class="c1">#     transient_for=self.main_window,</span>
            <span class="c1">#     flags=0,</span>
            <span class="c1">#     message_type=Gtk.MessageType.INFO,</span>
            <span class="c1">#     buttons=Gtk.ButtonsType.OK,</span>
            <span class="c1">#     text=&quot;Traitement automatique terminé&quot;</span>
            <span class="c1"># )</span>
            <span class="c1"># dialog.format_secondary_text(f&quot;✅ {processed}/{total} albums ont été automatiquement traités et optimisés.\n\nVos albums sont maintenant prêts à l&#39;usage !&quot;)</span>
            <span class="c1"># dialog.run()</span>
            <span class="c1"># dialog.destroy()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⚠️ Traitement automatique interrompu.</span><span class="se">\n</span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> albums traités.&quot;</span>
        
        <span class="c1"># Réinitialiser la barre de progression</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">set_fraction</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;Prêt&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_albums_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reload_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rafraîchit l&#39;affichage des albums en rescannant le dossier actuel&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Récupère le dossier actuellement affiché</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;current_folder&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span><span class="p">:</span>
                <span class="c1"># Rescanne le dossier pour récupérer les noms mis à jour</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">services.music_scanner</span><span class="w"> </span><span class="kn">import</span> <span class="n">MusicScanner</span>
                <span class="n">scanner</span> <span class="o">=</span> <span class="n">MusicScanner</span><span class="p">()</span>
                
                <span class="c1"># Forcer le rechargement des métadonnées si demandé</span>
                <span class="n">updated_albums</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">scan_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span><span class="p">)</span>
                
                <span class="c1"># Met à jour l&#39;affichage avec les nouvelles données</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_albums_display</span><span class="p">(</span><span class="n">updated_albums</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Pas de dossier actuel pour rafraîchissement</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors du rafraîchissement: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_css</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Charge les fichiers CSS pour les styles&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="n">Gdk</span><span class="o">.</span><span class="n">Screen</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>
            <span class="n">style_context</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">StyleContext</span><span class="p">()</span>
            
            <span class="c1"># Charger le CSS principal des boutons</span>
            <span class="n">css_provider</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">CssProvider</span><span class="p">()</span>
            <span class="n">css_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;styles.css&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">css_file</span><span class="p">):</span>
                <span class="n">css_provider</span><span class="o">.</span><span class="n">load_from_path</span><span class="p">(</span><span class="n">css_file</span><span class="p">)</span>
                <span class="n">style_context</span><span class="o">.</span><span class="n">add_provider_for_screen</span><span class="p">(</span>
                    <span class="n">screen</span><span class="p">,</span> <span class="n">css_provider</span><span class="p">,</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">STYLE_PROVIDER_PRIORITY_APPLICATION</span>
                <span class="p">)</span>
            
            <span class="c1"># Charger le thème moderne pour les cartes</span>
            <span class="n">modern_css_provider</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">CssProvider</span><span class="p">()</span>
            <span class="n">modern_css_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;css&quot;</span><span class="p">,</span> <span class="s2">&quot;modern_theme.css&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">modern_css_file</span><span class="p">):</span>
                <span class="n">modern_css_provider</span><span class="o">.</span><span class="n">load_from_path</span><span class="p">(</span><span class="n">modern_css_file</span><span class="p">)</span>
                <span class="n">style_context</span><span class="o">.</span><span class="n">add_provider_for_screen</span><span class="p">(</span>
                    <span class="n">screen</span><span class="p">,</span> <span class="n">modern_css_provider</span><span class="p">,</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">STYLE_PROVIDER_PRIORITY_APPLICATION</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Erreur lors du chargement du CSS: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2025, Rono.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>