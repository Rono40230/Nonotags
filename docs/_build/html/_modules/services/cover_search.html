

<!DOCTYPE html>
<html class="writer-html5" lang="fr" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>services.cover_search &mdash; Documentation Nonotags 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=05dadb3a"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/translations.js?v=e6b791cb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Nonotags
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Guide utilisateur:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation de Nonotags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilisation.html">Guide d‚Äôutilisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_core.html">API Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_services.html">API Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_ui.html">API UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_support.html">API Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_database.html">API Database</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules d√©taill√©s:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">core</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Nonotags</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Code du module</a></li>
      <li class="breadcrumb-item active">services.cover_search</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Code source de services.cover_search</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Service de recherche de pochettes d&#39;albums sur Internet</span>
<span class="sd">Utilise les APIs MusicBrainz et Discogs pour trouver des pochettes</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">support.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">support.config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>


<div class="viewcode-block" id="CoverSearchError">
<a class="viewcode-back" href="../../api_services.html#services.cover_search.CoverSearchError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CoverSearchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception pour les erreurs de recherche de pochettes&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="CoverResult">
<a class="viewcode-back" href="../../api_services.html#services.cover_search.CoverResult">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CoverResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;R√©sultat de recherche de pochette&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">thumbnail_url</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_url</span> <span class="o">=</span> <span class="n">thumbnail_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>  <span class="c1"># (width, height)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">format</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;CoverResult(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2">)&quot;</span></div>



<div class="viewcode-block" id="CoverSearchService">
<a class="viewcode-back" href="../../api_services.html#services.cover_search.CoverSearchService">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CoverSearchService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service de recherche de pochettes d&#39;albums&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise le service de recherche&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">AppLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">()</span>
        
        <span class="c1"># Configuration des APIs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_base</span> <span class="o">=</span> <span class="s2">&quot;https://musicbrainz.org/ws/2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverart_base</span> <span class="o">=</span> <span class="s2">&quot;https://coverartarchive.org&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discogs_base</span> <span class="o">=</span> <span class="s2">&quot;https://api.discogs.com&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itunes_base</span> <span class="o">=</span> <span class="s2">&quot;https://itunes.apple.com/search&quot;</span>
        
        <span class="c1"># Headers pour les requ√™tes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Nonotags/1.0 ( https://github.com/Rono40230/Nonotags )&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="p">}</span>
        
        <span class="c1"># Configuration des timeouts et limites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_results</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># Taille minimum 200x200 (plus souple)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">]</span>  <span class="c1"># JPG uniquement comme demand√©</span>
        
        <span class="c1"># D√©lais entre requ√™tes (politesse envers les APIs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_delay</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Plus rapide</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request_time</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CoverSearchService initialis√©&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Respecte les limites de taux des APIs&quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_since_last</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_request_time</span>
        
        <span class="k">if</span> <span class="n">time_since_last</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_delay</span><span class="p">:</span>
            <span class="n">wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_delay</span> <span class="o">-</span> <span class="n">time_since_last</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Effectue une requ√™te HTTP avec gestion d&#39;erreurs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_rate_limit</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">req_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
                <span class="n">req_headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requ√™te: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">req_headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ressource non trouv√©e: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requ√™te r√©ussie: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
            
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Erreur requ√™te </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raise_on_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoverSearchError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="CoverSearchService.search_covers">
<a class="viewcode-back" href="../../api_services.html#services.cover_search.CoverSearchService.search_covers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">search_covers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recherche des pochettes pour un album donn√©</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            artist (str): Nom de l&#39;artiste</span>
<span class="sd">            album (str): Nom de l&#39;album</span>
<span class="sd">            year (str, optional): Ann√©e de l&#39;album</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            list[CoverResult]: Liste des pochettes trouv√©es</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">artist</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">album</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoverSearchError</span><span class="p">(</span><span class="s2">&quot;Artiste et album requis&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recherche pochettes: </span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">album</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç Recherche pochettes: </span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">album</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># 1. Recherche via MusicBrainz + Cover Art Archive</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üì° Recherche MusicBrainz...&quot;</span><span class="p">)</span>
            <span class="n">mb_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_musicbrainz</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mb_results</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ MusicBrainz: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mb_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> r√©sultats&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MusicBrainz: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mb_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> r√©sultats&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Erreur MusicBrainz: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        
        <span class="c1"># 2. Recherche via iTunes (prioritaire, haute qualit√©)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üéµ Recherche iTunes...&quot;</span><span class="p">)</span>
                <span class="n">itunes_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_itunes</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">itunes_results</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ iTunes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">itunes_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> r√©sultats&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iTunes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">itunes_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> r√©sultats&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Erreur iTunes: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        
        <span class="c1"># 3. Recherche via Discogs (toujours disponible)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üìÄ Recherche Discogs...&quot;</span><span class="p">)</span>
                <span class="n">discogs_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_discogs</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">discogs_results</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Discogs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">discogs_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> r√©sultats&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discogs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">discogs_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> r√©sultats&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Erreur Discogs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        
        <span class="c1"># Si aucun r√©sultat et des erreurs, lever une exception informative</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoverSearchError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aucun r√©sultat trouv√©. Erreurs: </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Filtrer et trier les r√©sultats</span>
        <span class="n">filtered_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_and_sort_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üéØ R√©sultats finaux: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> pochettes (sur </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> trouv√©es)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trouv√© </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> pochettes&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filtered_results</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_search_musicbrainz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recherche via MusicBrainz + Cover Art Archive&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Essayer plusieurs variantes de recherche</span>
            <span class="n">search_queries</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># 1. Recherche exacte</span>
            <span class="n">query_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;artist:&quot;</span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;release:&quot;</span><span class="si">{</span><span class="n">album</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;date:</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">search_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_parts</span><span class="p">))</span>
            
            <span class="c1"># 2. Recherche plus souple (sans guillemets)</span>
            <span class="n">query_parts_loose</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;artist:</span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;release:</span><span class="si">{</span><span class="n">album</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">query_parts_loose</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;date:</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">search_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_parts_loose</span><span class="p">))</span>
            
            <span class="c1"># 3. Recherche par mots-cl√©s de l&#39;album</span>
            <span class="n">album_words</span> <span class="o">=</span> <span class="n">album</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">album_words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">album_keywords</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;release:</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">album_words</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">album_keywords</span><span class="p">:</span>
                    <span class="n">search_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;artist:</span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s1"> AND (</span><span class="si">{</span><span class="n">album_keywords</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            
            <span class="c1"># 4. Recherche par artiste seulement (pour trouver des albums proches)</span>
            <span class="n">search_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;artist:</span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">search_queries</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tentative </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/4: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">encoded_query</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">search_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_base</span><span class="si">}</span><span class="s2">/release/?query=</span><span class="si">{</span><span class="n">encoded_query</span><span class="si">}</span><span class="s2">&amp;fmt=json&amp;limit=10&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL MusicBrainz: </span><span class="si">{</span><span class="n">search_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">search_url</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Aucune r√©ponse de MusicBrainz&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">releases</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;releases&#39;</span><span class="p">,</span> <span class="p">[])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MusicBrainz: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span><span class="si">}</span><span class="s2"> releases trouv√©es pour query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Log des r√©sultats pour debug</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">release</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">releases</span><span class="p">[:</span><span class="mi">5</span><span class="p">]):</span>
                    <span class="n">release_title</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                    <span class="n">release_date</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">release_title</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> (</span><span class="si">{</span><span class="n">release_date</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">releases</span><span class="p">:</span>
                    <span class="c1"># Pour chaque release, chercher les pochettes</span>
                    <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Limiter √† 5 releases</span>
                        <span class="n">release_id</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                        <span class="n">release_title</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">release_id</span><span class="p">:</span>
                            <span class="k">continue</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recherche covers pour release: </span><span class="si">{</span><span class="n">release_title</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">release_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="n">cover_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coverart_for_release</span><span class="p">(</span><span class="n">release_id</span><span class="p">,</span> <span class="n">release</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cover_results</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trouv√© </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cover_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> covers pour </span><span class="si">{</span><span class="n">release_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Si on a trouv√© des r√©sultats, arr√™ter seulement si c&#39;est une recherche pr√©cise</span>
                    <span class="k">if</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Arr√™ter seulement pour les 2 premi√®res tentatives pr√©cises</span>
                        <span class="k">break</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur recherche MusicBrainz: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_coverart_for_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">release_id</span><span class="p">,</span> <span class="n">release_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;R√©cup√®re les pochettes pour une release MusicBrainz&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cover_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coverart_base</span><span class="si">}</span><span class="s2">/release/</span><span class="si">{</span><span class="n">release_id</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">cover_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">results</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="c1"># Filtres de qualit√© stricts</span>
                
                <span class="c1"># 1. Privil√©gier les images &quot;front&quot; uniquement</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Image ignor√©e: pas une couverture avant&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># V√©rifier l&#39;extension dans l&#39;URL (JPG uniquement)</span>
                <span class="n">image_url</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">image_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                    
                <span class="c1"># V√©rifier que c&#39;est bien du JPG</span>
                <span class="n">is_jpg</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">fmt</span> <span class="ow">in</span> <span class="n">image_url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_jpg</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image ignor√©e: format non-JPG - </span><span class="si">{</span><span class="n">image_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># 3. V√©rifier les dimensions si disponibles</span>
                <span class="n">thumbnails</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thumbnails&#39;</span><span class="p">,</span> <span class="p">{})</span>
                
                <span class="c1"># Essayer de d√©duire la taille depuis les thumbnails</span>
                <span class="n">has_large_thumbnail</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">thumb_size</span><span class="p">,</span> <span class="n">thumb_url</span> <span class="ow">in</span> <span class="n">thumbnails</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">thumb_size</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="s1">&#39;500&#39;</span><span class="p">,</span> <span class="s1">&#39;1200&#39;</span><span class="p">]:</span>
                        <span class="n">has_large_thumbnail</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                
                <span class="c1"># Si pas de grande miniature, l&#39;image est probablement petite</span>
                <span class="k">if</span> <span class="n">thumbnails</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_large_thumbnail</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Image ignor√©e: probablement trop petite (pas de grande miniature)&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># 4. Validation finale de l&#39;image via requ√™te HEAD pour obtenir les m√©tadonn√©es</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_image_quality</span><span class="p">(</span><span class="n">image_url</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">CoverResult</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
                        <span class="n">thumbnail_url</span><span class="o">=</span><span class="n">thumbnails</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">image_url</span><span class="p">),</span>
                        <span class="n">source</span><span class="o">=</span><span class="s1">&#39;Cover Art Archive&#39;</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jpeg&#39;</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image accept√©e: </span><span class="si">{</span><span class="n">image_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image rejet√©e apr√®s validation: </span><span class="si">{</span><span class="n">image_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cover Art Archive: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> images pour </span><span class="si">{</span><span class="n">release_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pas de pochettes Cover Art Archive pour </span><span class="si">{</span><span class="n">release_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_search_itunes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recherche via l&#39;API iTunes&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Construire la requ√™te iTunes</span>
            <span class="n">query_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_parts</span><span class="p">)</span>
            
            <span class="c1"># Param√®tres de recherche iTunes</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
                <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
                <span class="s1">&#39;entity&#39;</span><span class="p">:</span> <span class="s1">&#39;album&#39;</span><span class="p">,</span>
                <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="mi">20</span>
            <span class="p">}</span>
            
            <span class="c1"># URL de recherche</span>
            <span class="n">search_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">itunes_base</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">search_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">albums</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iTunes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">albums</span><span class="p">)</span><span class="si">}</span><span class="s2"> albums trouv√©s&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">album_data</span> <span class="ow">in</span> <span class="n">albums</span><span class="p">:</span>
                <span class="c1"># R√©cup√©rer l&#39;URL de l&#39;artwork</span>
                <span class="n">artwork_url</span> <span class="o">=</span> <span class="n">album_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;artworkUrl100&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">artwork_url</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># iTunes fournit des URLs en 100x100 par d√©faut, on peut les agrandir</span>
                <span class="c1"># Remplacer 100x100 par une taille plus grande</span>
                <span class="n">high_res_url</span> <span class="o">=</span> <span class="n">artwork_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;100x100&#39;</span><span class="p">,</span> <span class="s1">&#39;600x600&#39;</span><span class="p">)</span>
                
                <span class="c1"># V√©rifier que c&#39;est du JPG</span>
                <span class="n">is_jpg</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">fmt</span> <span class="ow">in</span> <span class="n">high_res_url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_jpg</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image iTunes ignor√©e: format non-JPG - </span><span class="si">{</span><span class="n">high_res_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Valider la qualit√© de l&#39;image</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_image_quality</span><span class="p">(</span><span class="n">high_res_url</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">CoverResult</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">high_res_url</span><span class="p">,</span>
                        <span class="n">thumbnail_url</span><span class="o">=</span><span class="n">artwork_url</span><span class="p">,</span>  <span class="c1"># 100x100 comme miniature</span>
                        <span class="n">source</span><span class="o">=</span><span class="s1">&#39;iTunes&#39;</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jpeg&#39;</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image iTunes accept√©e: </span><span class="si">{</span><span class="n">high_res_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image iTunes rejet√©e apr√®s validation: </span><span class="si">{</span><span class="n">high_res_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur recherche iTunes: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_image_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_url</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Valide la qualit√© d&#39;une image (version simplifi√©e)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Validation simple: essayer juste de t√©l√©charger les headers</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">image_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            
            <span class="c1"># Si HEAD ne fonctionne pas, essayer GET avec limite</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
            <span class="c1"># V√©rifier le type de contenu</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image rejet√©e: type non-image - </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Accepter toutes les images pour l&#39;instant (validation plus souple)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image accept√©e: </span><span class="si">{</span><span class="n">image_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur validation image </span><span class="si">{</span><span class="n">image_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># En cas d&#39;erreur, accepter l&#39;image quand m√™me</span>
            <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_search_discogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recherche via l&#39;API Discogs (mode public)&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Construire la requ√™te</span>
            <span class="n">query_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_parts</span><span class="p">)</span>
            
            <span class="n">search_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discogs_base</span><span class="si">}</span><span class="s2">/database/search&quot;</span>
            
            <span class="c1"># Param√®tres de recherche</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span>
                <span class="s1">&#39;per_page&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
            
            <span class="c1"># Headers sp√©ciaux pour Discogs (User-Agent obligatoire)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Nonotags/1.0 +https://github.com/Rono40230/Nonotags&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.discogs.v2.discogs+json&#39;</span>
            <span class="p">}</span>
            
            <span class="c1"># V√©rifier si on a un token configur√© (optionnel)</span>
            <span class="n">discogs_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discogs_token&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">discogs_token</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Discogs token=</span><span class="si">{</span><span class="n">discogs_token</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üîë Utilisation token Discogs configur√©&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;üåê Utilisation API Discogs publique&quot;</span><span class="p">)</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">search_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            
            <span class="c1"># G√©rer les erreurs sp√©cifiques</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="c1"># Essayer sans token si l&#39;autorisation √©choue</span>
                <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚ùå Token invalide, tentative sans token...&quot;</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">search_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Acc√®s Discogs non autoris√© - API peut-√™tre restreinte&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">results</span>
            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Acc√®s Discogs refus√© - quota ou restrictions&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Limite de taux Discogs atteinte&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">releases</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìÄ Discogs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span><span class="si">}</span><span class="s2"> releases trouv√©es&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discogs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span><span class="si">}</span><span class="s2"> releases trouv√©es&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Limiter √† 5 releases</span>
                <span class="c1"># R√©cup√©rer l&#39;image de couverture</span>
                <span class="n">cover_image</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cover_image&#39;</span><span class="p">)</span>
                <span class="n">thumb</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thumb&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cover_image</span> <span class="ow">or</span> <span class="n">cover_image</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># V√©rifier que c&#39;est du JPG</span>
                <span class="n">is_jpg</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">fmt</span> <span class="ow">in</span> <span class="n">cover_image</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_jpg</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image Discogs ignor√©e: format non-JPG - </span><span class="si">{</span><span class="n">cover_image</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Valider la qualit√© de l&#39;image</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_image_quality</span><span class="p">(</span><span class="n">cover_image</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">CoverResult</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">cover_image</span><span class="p">,</span>
                        <span class="n">thumbnail_url</span><span class="o">=</span><span class="n">thumb</span> <span class="ow">or</span> <span class="n">cover_image</span><span class="p">,</span>
                        <span class="n">source</span><span class="o">=</span><span class="s1">&#39;Discogs&#39;</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jpeg&#39;</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image Discogs accept√©e: </span><span class="si">{</span><span class="n">cover_image</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image Discogs rejet√©e apr√®s validation: </span><span class="si">{</span><span class="n">cover_image</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur r√©seau Discogs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Erreur r√©seau Discogs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur inattendue Discogs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Erreur Discogs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_and_sort_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filtre et trie les r√©sultats par qualit√©&quot;&quot;&quot;</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="c1"># √âviter les doublons</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">result</span><span class="o">.</span><span class="n">url</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="c1"># V√©rifier la taille si disponible</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">size</span>
                <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span><span class="p">:</span>
                    <span class="k">continue</span>
            
            <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="c1"># Trier par source (ordre de priorit√©)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">sort_key</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">source_priority</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Cover Art Archive&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Meilleure qualit√©, source officielle</span>
                <span class="s1">&#39;iTunes&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>            <span class="c1"># Haute qualit√©, source officielle</span>
                <span class="s1">&#39;Discogs&#39;</span><span class="p">:</span> <span class="mi">2</span>            <span class="c1"># Qualit√© variable, parfois petites images</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">source_priority</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="n">filtered</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">filtered</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_results</span><span class="p">]</span>
    
<div class="viewcode-block" id="CoverSearchService.download_cover">
<a class="viewcode-back" href="../../api_services.html#services.cover_search.CoverSearchService.download_cover">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cover_result</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        T√©l√©charge une pochette et la sauvegarde</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            cover_result (CoverResult): R√©sultat de recherche</span>
<span class="sd">            output_path (str): Chemin de sauvegarde</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True si le t√©l√©chargement a r√©ussi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;T√©l√©chargement pochette: </span><span class="si">{</span><span class="n">cover_result</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">cover_result</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># V√©rifier le type de contenu</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;image/&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type de contenu invalide: </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Traiter l&#39;image avec PIL</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_data</span><span class="p">))</span>
            
            <span class="c1"># V√©rifier la taille minimum</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image trop petite: </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Redimensionner si n√©cessaire (carr√©)</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">!=</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">crop</span><span class="p">(((</span><span class="n">width</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> 
                                 <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
            
            <span class="c1"># Redimensionner √† 500x500 maximum</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
            
            <span class="c1"># Sauvegarder</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;JPEG&#39;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pochette sauvegard√©e: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur t√©l√©chargement pochette: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="CoverSearchService.get_image_info">
<a class="viewcode-back" href="../../api_services.html#services.cover_search.CoverSearchService.get_image_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cover_result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtient les informations d&#39;une image sans la t√©l√©charger</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            cover_result (CoverResult): R√©sultat de recherche</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Informations sur l&#39;image (taille, format, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># T√©l√©charger seulement les headers</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">cover_result</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
            <span class="n">content_length</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">)</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
                <span class="s1">&#39;size_bytes&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span> <span class="k">if</span> <span class="n">content_length</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">content_type</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">}</span>
            
            <span class="c1"># Essayer d&#39;obtenir la taille de l&#39;image</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">cover_result</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">cover_result</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">cover_result</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            
            <span class="k">return</span> <span class="n">info</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur info image: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span></div>

    
<div class="viewcode-block" id="CoverSearchService.validate_cover_file">
<a class="viewcode-back" href="../../api_services.html#services.cover_search.CoverSearchService.validate_cover_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_cover_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Valide un fichier de pochette existant</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            file_path (str): Chemin vers le fichier</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: Informations de validation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;size_bytes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Fichier introuvable&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            
            <span class="c1"># Taille du fichier</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;size_bytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="c1"># Ouvrir avec PIL</span>
            <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            
            <span class="c1"># Validations</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Largeur trop petite: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hauteur trop petite: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_cover_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Format non support√©: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;size_bytes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># 5MB max</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fichier trop volumineux: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;size_bytes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
            
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur validation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2025, Rono.</p>
  </div>

  Compil√© avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">th√®me</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>